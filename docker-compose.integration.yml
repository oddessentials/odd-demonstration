# Docker Compose Integration Mode
# Extends docker-compose.demo.yml with integration-specific overrides:
# - Health checks with per-image appropriate tooling
# - Shorter timeouts for fast-fail
# - Fixed seed data for deterministic tests

services:
  # PostgreSQL - Event sourcing store
  postgres:
    container_name: odto-integ-postgres
    image: postgres:15-alpine
    networks: [odto-integ-net]
    environment:
      POSTGRES_USER: observatory
      POSTGRES_PASSWORD: demo
      POSTGRES_DB: events
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U observatory -d events"]
      interval: 2s
      timeout: 5s
      retries: 15

  # MongoDB - Job metadata store
  mongodb:
    container_name: odto-integ-mongo
    image: mongo:7
    networks: [odto-integ-net]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 2s
      timeout: 5s
      retries: 15

  # Redis - Caching layer
  redis:
    container_name: odto-integ-redis
    image: redis:7-alpine
    networks: [odto-integ-net]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 15

  # RabbitMQ - Message broker
  rabbitmq:
    container_name: odto-integ-rabbitmq
    image: rabbitmq:3-management-alpine
    networks: [odto-integ-net]
    environment:
      RABBITMQ_DEFAULT_USER: observatory
      RABBITMQ_DEFAULT_PASS: demo
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 2s
      timeout: 5s
      retries: 15

  # Gateway - API entry point (Node.js - has wget)
  gateway:
    container_name: odto-integ-gateway
    image: node:20-alpine
    working_dir: /app
    networks: [odto-integ-net]
    ports:
      - "13000:3000"
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - PORT=3000
      - RABBITMQ_URL=amqp://observatory:demo@odto-integ-rabbitmq:5672
      - POSTGRES_URL=postgres://observatory:demo@odto-integ-postgres:5432/events
    volumes:
      - ./src/services/gateway:/app:ro
    command: sh -c "npm install --omit=dev && npm start"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/healthz"]
      interval: 2s
      timeout: 5s
      retries: 15

  # Processor - Job execution (Python - has python)
  processor:
    container_name: odto-integ-processor
    image: python:3.11-slim
    working_dir: /app
    networks: [odto-integ-net]
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBITMQ_URL=amqp://observatory:demo@odto-integ-rabbitmq:5672
    volumes:
      - ./src/services/processor:/app:ro
    command: sh -c "pip install --no-cache-dir -r requirements.txt && python main.py"
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import socket; socket.create_connection((\"localhost\", 5672), 2)' 2>/dev/null || exit 0"]
      interval: 5s
      timeout: 10s
      retries: 10
      start_period: 30s

  # Metrics Engine - Observability (Go - use shell)
  metrics-engine:
    container_name: odto-integ-metrics-engine
    image: golang:1.21-alpine
    working_dir: /app
    networks: [odto-integ-net]
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBITMQ_URL=amqp://observatory:demo@odto-integ-rabbitmq:5672
    volumes:
      - ./src/services/metrics-engine:/app:ro
    command: sh -c "go run ."

  # Read Model - Query API (Go - use shell with nc)
  read-model:
    container_name: odto-integ-read-model
    image: golang:1.21-alpine
    working_dir: /app
    networks: [odto-integ-net]
    ports:
      - "18080:8080"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - MONGO_URL=mongodb://odto-integ-mongo:27017
      - POSTGRES_URL=postgres://observatory:demo@odto-integ-postgres:5432/events
    volumes:
      - ./src/services/read-model:/app:ro
    command: sh -c "go run ."
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/health || exit 1"]
      interval: 2s
      timeout: 5s
      retries: 15

networks:
  odto-integ-net:
    name: odto-integ-net

# Port mapping summary (integration mode uses same 13000+ range as demo):
# 
# | Service        | Internal | Host Port | Purpose           |
# |----------------|----------|-----------|-------------------|
# | gateway        | 3000     | 13000     | API               |
# | read-model     | 8080     | 18080     | Query API         |
# | postgres       | 5432     | -         | Internal only     |
# | mongodb        | 27017    | -         | Internal only     |
# | redis          | 6379     | -         | Internal only     |
# | rabbitmq-amqp  | 5672     | -         | Internal only     |
