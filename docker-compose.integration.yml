# Docker Compose Integration Mode
# Uses pre-built Docker Hub images for fast, reliable integration tests.
# Invariants: I3 (self-contained), I4 (<120s runtime), I5 (artifact capture)
#
# HEALTH CHECK STRATEGY:
# - Infrastructure (postgres, mongodb, redis, rabbitmq): Compose-level health checks
#   for dependency ordering via `depends_on: condition: service_healthy`
# - Application services (gateway, processor, metrics-engine, read-model):
#   NO compose-level health checks. Integration harness owns all readiness probes
#   via authoritative HTTP checks on exposed ports.
#
# NOTE: On PRs, this uses the last images pushed from `main`.
# PR-specific code changes are NOT reflected in integration tests.
# This provides a post-merge safety net, not PR validation.

services:
  # ============================================================
  # Infrastructure Services (compose-level health checks)
  # ============================================================

  # PostgreSQL - Event sourcing store
  postgres:
    container_name: odto-integ-postgres
    image: postgres:15-alpine
    networks: [odto-integ-net]
    environment:
      POSTGRES_USER: observatory
      POSTGRES_PASSWORD: demo
      POSTGRES_DB: events
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U observatory -d events"]
      interval: 2s
      timeout: 5s
      retries: 15

  # MongoDB - Job metadata store
  mongodb:
    container_name: odto-integ-mongo
    image: mongo:7
    networks: [odto-integ-net]
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 2s
      timeout: 5s
      retries: 15

  # Redis - Caching layer
  redis:
    container_name: odto-integ-redis
    image: redis:7-alpine
    networks: [odto-integ-net]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 5s
      retries: 15

  # RabbitMQ - Message broker
  # Note: Erlang distribution can fail on fast container starts (race condition)
  # restart: on-failure handles this by automatically retrying
  rabbitmq:
    container_name: odto-integ-rabbitmq
    image: rabbitmq:3-management-alpine
    networks: [odto-integ-net]
    restart: on-failure:3
    environment:
      RABBITMQ_DEFAULT_USER: observatory
      RABBITMQ_DEFAULT_PASS: demo
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 3s
      timeout: 10s
      retries: 15
      start_period: 10s

  # Prometheus - Metrics and alerting (for TUI dashboard alerts)
  prometheus:
    container_name: odto-integ-prometheus
    image: prom/prometheus:latest
    networks: [odto-integ-net]
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    volumes:
      - ./infra/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9090/-/healthy"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Grafana - Observability dashboards
  grafana:
    container_name: odto-integ-grafana
    image: grafana/grafana:latest
    networks: [odto-integ-net]
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
    volumes:
      - ./infra/grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      prometheus:
        condition: service_healthy

  # ============================================================
  # Application Services (harness-level health checks only)
  # Readiness is proven by integration harness via HTTP probes
  # ============================================================

  # Gateway - API entry point (pre-built from Docker Hub)
  gateway:
    container_name: odto-integ-gateway
    image: oddessentials/odto-gateway:latest
    networks: [odto-integ-net]
    ports:
      - "13000:3000"
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - NODE_ENV=production
      - PORT=3000
      - RABBITMQ_URL=amqp://observatory:demo@odto-integ-rabbitmq:5672
      - POSTGRES_URL=postgres://observatory:demo@odto-integ-postgres:5432/events?sslmode=disable
    # Readiness: harness probes GET http://localhost:13000/healthz

  # Processor - Job execution (pre-built from Docker Hub)
  processor:
    container_name: odto-integ-processor
    image: oddessentials/odto-processor:latest
    networks: [odto-integ-net]
    depends_on:
      rabbitmq:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - RABBITMQ_URL=amqp://observatory:demo@odto-integ-rabbitmq:5672
      - POSTGRES_URL=postgresql://observatory:demo@odto-integ-postgres:5432/events
    # Readiness: harness verifies job processing via Gateway/Read Model

  # Metrics Engine - Observability (pre-built from Docker Hub)
  metrics-engine:
    container_name: odto-integ-metrics-engine
    image: oddessentials/odto-metrics-engine:latest
    networks: [odto-integ-net]
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      - RABBITMQ_URL=amqp://observatory:demo@odto-integ-rabbitmq:5672
    # Readiness: harness verifies metrics via P4 proof path

  # Read Model - Query API (pre-built from Docker Hub)
  read-model:
    container_name: odto-integ-read-model
    image: oddessentials/odto-read-model:latest
    networks: [odto-integ-net]
    ports:
      - "18080:8080"
    depends_on:
      mongodb:
        condition: service_healthy
      postgres:
        condition: service_healthy
    environment:
      - MONGO_URL=mongodb://odto-integ-mongo:27017
      - POSTGRES_URL=postgres://observatory:demo@odto-integ-postgres:5432/events?sslmode=disable
    # Readiness: harness probes GET http://localhost:18080/health

  # Web PTY Server - Terminal WebSocket broker
  # Built from repo root with real TUI for visual regression testing
  web-pty-server:
    container_name: odto-integ-web-pty
    build:
      context: .
      dockerfile: src/services/web-pty-server/Dockerfile
      target: real
    networks: [odto-integ-net]
    ports:
      - "9000:9000"  # WebSocket
      - "9001:9001"  # Metrics
    depends_on:
      read-model:
        condition: service_started
      gateway:
        condition: service_started
    environment:
      # Canonical path contract: PTY_TUI_BINARY=/app/odd-dashboard (default in image)
      - PTY_WS_PORT=9000
      - PTY_METRICS_PORT=9001
      - READ_MODEL_URL=http://odto-integ-read-model:8080
      - GATEWAY_URL=http://odto-integ-gateway:3000
      - PROMETHEUS_URL=http://odto-integ-prometheus:9090
    # Readiness: web-ui nginx proxies to this service

  # Web UI - nginx serving static + proxying WebSocket (built locally)
  web-ui:
    container_name: odto-integ-web-ui
    build:
      context: src/interfaces/web
      dockerfile: Dockerfile
    networks: [odto-integ-net]
    ports:
      - "8081:80"
    depends_on:
      - web-pty-server
      - read-model
    volumes:
      # Mount integration-specific nginx config
      - ./src/interfaces/web/nginx.integration.conf:/etc/nginx/conf.d/default.conf:ro
    # Readiness: harness probes GET http://localhost:8081/health

networks:
  odto-integ-net:
    name: odto-integ-net

# Port mapping summary (integration mode uses 13000+ range):
# 
# | Service        | Internal | Host Port | Purpose           |
# |----------------|----------|-----------|-------------------|
# | gateway        | 3000     | 13000     | API               |
# | read-model     | 8080     | 18080     | Query API         |
# | postgres       | 5432     | -         | Internal only     |
# | mongodb        | 27017    | -         | Internal only     |
# | redis          | 6379     | -         | Internal only     |
# | rabbitmq-amqp  | 5672     | -         | Internal only     |
