apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-rules
data:
  alert-rules.yml: |
    groups:
      - name: observatory-alerts
        rules:
          # Service Down Alert
          - alert: ServiceDown
            expr: up{job=~"gateway|processor"} == 0
            for: 1m
            labels:
              severity: critical
              service: "{{ $labels.job }}"
            annotations:
              summary: "{{ $labels.job }} service is down"
              description: "The {{ $labels.job }} service has been unreachable for more than 1 minute."

          # Job Failure Rate High (with divide-by-zero guard)
          - alert: JobFailureRateHigh
            expr: |
              (
                rate(processor_jobs_failed_total[5m]) 
                / 
                (rate(processor_jobs_completed_total[5m]) + rate(processor_jobs_failed_total[5m]) + 0.001)
              ) > 0.05
            for: 2m
            labels:
              severity: warning
              service: processor
            annotations:
              summary: "Job failure rate exceeds 5%"
              description: "The job failure rate has been above 5% for the last 2 minutes."

          # Gateway High Latency (demo-friendly threshold)
          - alert: GatewayHighLatency
            expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="gateway"}[5m])) > 1
            for: 5m
            labels:
              severity: warning
              service: gateway
            annotations:
              summary: "Gateway p95 latency > 1s"
              description: "The gateway service p95 latency has exceeded 1 second."

          # RabbitMQ Queue Growing (if metrics available)
          - alert: QueueBacklogGrowing
            expr: rabbitmq_queue_messages{queue="jobs.created"} > 100
            for: 5m
            labels:
              severity: warning
              service: rabbitmq
            annotations:
              summary: "RabbitMQ queue backlog growing"
              description: "The jobs.created queue has more than 100 pending messages."
