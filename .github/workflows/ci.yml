name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger for stall-repro job

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Bazel Build & Test
  # ============================================================
  bazel:
    name: Bazel Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bazelisk
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          # Use .bazelversion file to determine Bazel version
          use-bazelisk: true
          # Enable disk cache for faster builds
          disk-cache: ${{ github.workflow }}
          # Enable repository cache
          repository-cache: true
          # Generate external cache key based on lockfiles
          external-cache: true

      # Fast-fail: Ensure lockfile is up-to-date before any resolution
      - name: Verify MODULE.bazel.lock is current
        run: bazel mod deps --lockfile_mode=error

      # Graph isolation: Ensure no heavy deps leak into default build
      # This check becomes enforcing once @pip_heavy is defined
      - name: Check for @pip_heavy leakage
        run: |
          # Check if @pip_heavy exists first
          if bazel query '@pip_heavy//...' 2>/dev/null | head -1 > /dev/null; then
            LEAKS=$(bazel query 'deps(//...) intersect @pip_heavy//...' 2>/dev/null || echo "")
            if [ -n "$LEAKS" ]; then
              echo "ERROR: @pip_heavy dependencies leaked into default build graph:"
              echo "$LEAKS"
              exit 1
            fi
            echo "✓ No @pip_heavy leakage detected"
          else
            echo "⏭️ @pip_heavy not defined yet, skipping leakage check"
          fi

      - name: Build all targets (excluding heavy)
        timeout-minutes: 30
        run: bazel build //... --curses=no --show_progress --verbose_failures --build_tag_filters=-heavy

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bazel-testlogs
          path: bazel-testlogs/
          retention-days: 7

      # Phase 12: README structure governance (V6) - fails loudly on drift
      - name: README structure governance
        run: python scripts/check-readme-structure.py

  # ============================================================
  # Canonical Test Suite (V2: sole authority, V7: Linux pwsh proof)
  # ============================================================
  tests:
    name: Canonical Test Suite
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # V2: run-all-tests.ps1 is SOLE authority for test execution
      # V7: Linux pwsh execution proves portability
      - name: Run all tests (canonical entrypoint)
        shell: pwsh
        run: ./scripts/run-all-tests.ps1

      # Governance scripts (not bypassing run-all-tests.ps1, these are structural checks)
      - name: Verify service versions match K8s manifests
        run: python scripts/check-service-versions.py

      - name: Contract sanity checks
        run: python scripts/test-contracts-sanity.py

      - name: Schema compatibility check
        run: python scripts/check-schema-compat.py --ci

  # ============================================================
  # Stall Diagnostic (Manual trigger only)
  # ============================================================
  stall-repro:
    name: Stall Diagnostic (pip.parse isolation)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Manual trigger only
    
    steps:
      # Checkout to a separate directory to avoid polluting the main workspace
      - name: Checkout code (isolated path)
        uses: actions/checkout@v4
        with:
          path: repro-workspace

      - name: Set up Bazelisk (isolated cache)
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          use-bazelisk: true
          # Completely separate cache key to prevent poisoning main cache
          disk-cache: stall-repro-isolated-${{ github.run_id }}
          repository-cache: false  # Disable repo cache for isolation

      # Run in isolated minimal context
      - name: Run stall diagnostic
        timeout-minutes: 15
        working-directory: repro-workspace
        run: |
          echo "=== Stall Diagnostic: Testing pip.parse with editable install ==="
          
          # Create minimal workspace with only the repro requirements
          mkdir -p /tmp/stall-repro
          cd /tmp/stall-repro
          
          # Create minimal MODULE.bazel
          cat > MODULE.bazel << 'EOF'
          module(name = "stall_repro", version = "0.1.0")
          bazel_dep(name = "rules_python", version = "0.36.0")
          pip = use_extension("@rules_python//python/extensions:pip.bzl", "pip")
          pip.parse(
              hub_name = "pip_repro",
              python_version = "3.11",
              requirements_lock = "//:repro-requirements.txt",
          )
          use_repo(pip, "pip_repro")
          EOF
          
          # Copy repro requirements
          cp "$GITHUB_WORKSPACE/repro-workspace/repro/repro-requirements.txt" ./repro-requirements.txt
          
          # Create minimal BUILD.bazel
          echo 'exports_files(["repro-requirements.txt"])' > BUILD.bazel
          
          # Create .bazelversion
          echo "7.1.0" > .bazelversion
          
          echo "--- Starting pip.parse resolution timing ---"
          time bazel mod deps --curses=no --show_progress 2>&1 || echo "Resolution failed or timed out"
          echo "--- Diagnostic complete ---"
          
          # Clean up (isolated workspace, no need to restore)

  # ============================================================
  # Contract Validation (PowerShell)
  # ============================================================
  contracts:
    name: Contract Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Validate contracts
        shell: pwsh
        run: ./scripts/validate-contracts.ps1
        
      - name: Upload validation results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: contract-validation
          path: contracts/validation-results.json
          retention-days: 7

  # ============================================================
  # Container Image Builds (Future extensibility)
  # ============================================================
  # docker:
  #   name: Build Container Images
  #   runs-on: ubuntu-latest
  #   needs: [bazel]
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Build images
  #       run: |
  #         docker build -t gateway:ci src/services/gateway
  #         docker build -t processor:ci src/services/processor

  # ============================================================
  # Lint (Future extensibility)
  # ============================================================
  # lint:
  #   name: Lint & Format
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Run buildifier
  #       run: bazel run //:buildifier_check

  # ============================================================
  # Release (Future extensibility)
  # ============================================================
  # release:
  #   name: Create Release
  #   runs-on: ubuntu-latest
  #   needs: [bazel, docker]
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v1
