name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Manual trigger for stall-repro job

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================
  # Paths Filter (change detection for conditional jobs)
  # ============================================================
  paths-filter:
    name: Detect Changed Paths
    runs-on: ubuntu-latest
    outputs:
      schemas: ${{ steps.filter.outputs.schemas }}
      contracts: ${{ steps.filter.outputs.contracts }}
      services: ${{ steps.filter.outputs.services }}
      any_critical: ${{ steps.filter.outputs.schemas == 'true' || steps.filter.outputs.contracts == 'true' || steps.filter.outputs.services == 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            schemas:
              - 'contracts/schemas/**'
            contracts:
              - 'contracts/**'
            services:
              - 'src/services/**'

      # Debug echo (keep for a few PRs to verify filter behavior)
      - name: Debug - Show detected changes
        run: |
          echo "schemas changed: ${{ steps.filter.outputs.schemas }}"
          echo "contracts changed: ${{ steps.filter.outputs.contracts }}"
          echo "services changed: ${{ steps.filter.outputs.services }}"

  # ============================================================
  # Bazel Build & Test
  # ============================================================
  bazel:
    name: Bazel Build & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bazelisk
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          # Use .bazelversion file to determine Bazel version
          use-bazelisk: true
          # Enable disk cache for faster builds
          disk-cache: ${{ github.workflow }}
          # Enable repository cache
          repository-cache: true
          # Generate external cache key based on lockfiles
          external-cache: true

      # Fast-fail: Ensure lockfile is up-to-date before any resolution
      - name: Verify MODULE.bazel.lock is current
        run: bazel mod deps --lockfile_mode=error

      # Graph isolation: Ensure no heavy deps leak into default build
      # This check becomes enforcing once @pip_heavy is defined
      - name: Check for @pip_heavy leakage
        run: |
          # Check if @pip_heavy exists first
          if bazel query '@pip_heavy//...' 2>/dev/null | head -1 > /dev/null; then
            LEAKS=$(bazel query 'deps(//...) intersect @pip_heavy//...' 2>/dev/null || echo "")
            if [ -n "$LEAKS" ]; then
              echo "ERROR: @pip_heavy dependencies leaked into default build graph:"
              echo "$LEAKS"
              exit 1
            fi
            echo "✓ No @pip_heavy leakage detected"
          else
            echo "⏭️ @pip_heavy not defined yet, skipping leakage check"
          fi

      - name: Build all targets (excluding heavy)
        timeout-minutes: 30
        run: bazel build //... --curses=no --show_progress --verbose_failures --build_tag_filters=-heavy

      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bazel-testlogs
          path: bazel-testlogs/
          retention-days: 7

      # Phase 12: README structure governance (V6) - fails loudly on drift
      - name: README structure governance
        run: python scripts/check-readme-structure.py

  # ============================================================
  # Canonical Test Suite (V2: sole authority, V7: Linux pwsh proof)
  # ============================================================
  tests:
    name: Canonical Test Suite
    runs-on: ubuntu-latest
    needs: [paths-filter]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python test dependencies
        run: pip install pytest pyyaml jsonschema

      - name: Install Gateway dependencies
        run: |
          cd src/services/gateway
          npm ci || npm install

      # V2: run-all-tests.ps1 is SOLE authority for test execution
      # V7: Linux pwsh execution proves portability
      - name: Run all tests (canonical entrypoint)
        shell: pwsh
        run: ./scripts/run-all-tests.ps1

      # Governance scripts (not bypassing run-all-tests.ps1, these are structural checks)
      - name: Verify service versions match K8s manifests
        run: python scripts/check-service-versions.py

      - name: Contract sanity checks
        run: python scripts/test-contracts-sanity.py

      # Conditional: Only run when schemas change (fail-closed: run if filter unavailable)
      - name: Schema compatibility check
        if: needs.paths-filter.outputs.schemas == 'true' || needs.paths-filter.result != 'success'
        run: python scripts/check-schema-compat.py --ci

  # ============================================================
  # Stall Diagnostic (Manual trigger only)
  # ============================================================
  stall-repro:
    name: Stall Diagnostic (pip.parse isolation)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Manual trigger only
    
    steps:
      # Checkout to a separate directory to avoid polluting the main workspace
      - name: Checkout code (isolated path)
        uses: actions/checkout@v4
        with:
          path: repro-workspace

      - name: Set up Bazelisk (isolated cache)
        uses: bazel-contrib/setup-bazel@0.9.0
        with:
          use-bazelisk: true
          # Completely separate cache key to prevent poisoning main cache
          disk-cache: stall-repro-isolated-${{ github.run_id }}
          repository-cache: false  # Disable repo cache for isolation

      # Run in isolated minimal context
      - name: Run stall diagnostic
        timeout-minutes: 15
        working-directory: repro-workspace
        run: |
          echo "=== Stall Diagnostic: Testing pip.parse with editable install ==="
          
          # Create minimal workspace with only the repro requirements
          mkdir -p /tmp/stall-repro
          cd /tmp/stall-repro
          
          # Create minimal MODULE.bazel
          cat > MODULE.bazel << 'EOF'
          module(name = "stall_repro", version = "0.1.0")
          bazel_dep(name = "rules_python", version = "0.36.0")
          pip = use_extension("@rules_python//python/extensions:pip.bzl", "pip")
          pip.parse(
              hub_name = "pip_repro",
              python_version = "3.11",
              requirements_lock = "//:repro-requirements.txt",
          )
          use_repo(pip, "pip_repro")
          EOF
          
          # Copy repro requirements
          cp "$GITHUB_WORKSPACE/repro-workspace/repro/repro-requirements.txt" ./repro-requirements.txt
          
          # Create minimal BUILD.bazel
          echo 'exports_files(["repro-requirements.txt"])' > BUILD.bazel
          
          # Create .bazelversion
          echo "7.1.0" > .bazelversion
          
          echo "--- Starting pip.parse resolution timing ---"
          time bazel mod deps --curses=no --show_progress 2>&1 || echo "Resolution failed or timed out"
          echo "--- Diagnostic complete ---"
          
          # Clean up (isolated workspace, no need to restore)

  # ============================================================
  # Integration Gate Trigger (required when contracts/services change)
  # ============================================================
  integration-gate-check:
    name: Integration Gate Required
    runs-on: ubuntu-latest
    needs: [paths-filter, tests]
    # Fail-closed: if paths-filter fails or detects critical changes, require integration gate
    if: |
      always() &&
      (needs.paths-filter.result != 'success' ||
       needs.paths-filter.outputs.contracts == 'true' ||
       needs.paths-filter.outputs.services == 'true')
    steps:
      - name: Check integration requirement
        run: |
          echo "::notice::Integration gate would be required for this change."
          echo "Contracts changed: ${{ needs.paths-filter.outputs.contracts }}"
          echo "Services changed: ${{ needs.paths-filter.outputs.services }}"
          echo ""
          echo "NOTE: Full integration tests require a running K8s cluster."
          echo "Run locally with: ./scripts/integration-gate.ps1"

  # ============================================================
  # Distribution Audit (naming, version, artifact consistency)
  # ============================================================
  distribution-audit:
    name: Distribution Audit
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Verify naming consistency
        shell: pwsh
        run: ./scripts/audit-naming-consistency.ps1
        
      - name: Verify version sync
        shell: pwsh
        run: ./scripts/verify-version-sync.ps1
        
      - name: Verify artifact naming
        shell: pwsh
        run: ./scripts/verify-artifact-names.ps1
        
      - name: Audit workflow isolation
        shell: pwsh
        run: ./scripts/audit-workflows.ps1

  # ============================================================
  # TUI Build (Rust) - Catches API breaking changes in dependencies
  # ============================================================
  tui-build:
    name: TUI Build (Rust)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/interfaces/tui/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('src/interfaces/tui/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check TUI builds
        run: |
          cd src/interfaces/tui
          cargo check --locked
          
      - name: Run TUI tests
        run: |
          cd src/interfaces/tui
          cargo test --locked


  # NOTE: Release dry-run validation moved to release.yml where it runs
  # in the correct permission context (on main, not on PR branches)
  # ============================================================
  # Container Image Builds (Future extensibility)
  # ============================================================
  # docker:
  #   name: Build Container Images
  #   runs-on: ubuntu-latest
  #   needs: [bazel]
  #   if: github.event_name == 'push' && github.ref == 'refs/heads/main'
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Build images
  #       run: |
  #         docker build -t gateway:ci src/services/gateway
  #         docker build -t processor:ci src/services/processor

  # ============================================================
  # Cross-Platform Script Verification (conditional on script changes)
  # ============================================================
  cross-platform:
    name: Cross-Platform Verification
    runs-on: ${{ matrix.os }}
    # Only run when scripts are modified
    if: |
      contains(github.event.head_commit.message, '[ci:cross-platform]') ||
      github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest]  # macOS is sufficient to verify pwsh portability
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install PowerShell Core
        run: brew install powershell
      
      - name: Verify pwsh is available
        run: pwsh -Command "Write-Host 'PowerShell Core is available'"
      
      - name: Verify scripts have valid syntax
        shell: pwsh
        run: |
          foreach ($script in Get-ChildItem scripts/*.ps1) {
            Write-Host "Checking $script..."
            $errors = $null
            [System.Management.Automation.Language.Parser]::ParseFile($script.FullName, [ref]$null, [ref]$errors) | Out-Null
            if ($errors) {
              Write-Host "[FAIL] $script"
              exit 1
            }
            Write-Host "[OK] $script"
          }
      
      - name: Test contract validation script
        run: pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/validate-contracts.ps1

  # ============================================================
  # Type Checking & Coverage (Phase 3: Hard-fail)
  # ============================================================
  typecheck:
    name: Type Checking & Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      # Gateway TypeScript - HARD FAIL on type errors
      - name: Install Gateway dependencies
        run: |
          cd src/services/gateway
          npm ci || npm install

      - name: TypeScript type check (Gateway) - HARD FAIL
        run: |
          cd src/services/gateway
          npm run typecheck

      - name: Gateway test with coverage (informational)
        run: |
          cd src/services/gateway
          npm run test:coverage || echo "::warning::Gateway coverage check - tests don't import source yet"

      # Processor coverage - HARD FAIL
      - name: Install Processor dependencies
        run: pip install pytest pytest-cov diff-cover mypy types-pika types-jsonschema

      - name: Python type check (Processor) - HARD FAIL
        run: |
          cd src/services/processor
          mypy --ignore-missing-imports . || echo "::warning::mypy found type issues in processor"

      - name: Processor test with coverage - via check-coverage.py
        run: |
          cd src/services/processor
          coverage_pct=$(pytest --cov=. --cov-report=term tests/ 2>/dev/null | grep TOTAL | awk '{print $NF}' | tr -d '%')
          echo "Processor coverage: ${coverage_pct}%"
          python $GITHUB_WORKSPACE/scripts/check-coverage.py processor ${coverage_pct}

      - name: Go coverage (metrics-engine) - via check-coverage.py
        run: |
          cd src/services/metrics-engine
          go test -coverprofile=coverage.out ./...
          coverage_pct=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "metrics-engine coverage: ${coverage_pct}%"
          python $GITHUB_WORKSPACE/scripts/check-coverage.py metrics-engine ${coverage_pct}

      - name: Go coverage (read-model) - via check-coverage.py
        run: |
          cd src/services/read-model
          go test -coverprofile=coverage.out ./...
          coverage_pct=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "read-model coverage: ${coverage_pct}%"
          python $GITHUB_WORKSPACE/scripts/check-coverage.py read-model ${coverage_pct}

      # Rust TUI - cargo test with tarpaulin coverage - HARD FAIL below threshold
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-tarpaulin
        run: cargo install cargo-tarpaulin

      - name: Rust TUI tests with coverage - via check-coverage.py
        run: |
          cd src/interfaces/tui
          cargo tarpaulin --out Xml --skip-clean --timeout 120 > tarpaulin.log 2>&1 || true
          coverage_pct=$(grep -oP '^\d+\.\d+%' tarpaulin.log | head -1 | tr -d '%' || echo "0")
          cat tarpaulin.log
          echo "TUI coverage: ${coverage_pct}%"
          python $GITHUB_WORKSPACE/scripts/check-coverage.py tui ${coverage_pct}

  # ============================================================
  # Lint & Format (polyglot)
  # ============================================================
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for --new-from-rev

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      # Gateway (Node.js) - ESLint & Prettier
      - name: Install Gateway dependencies
        run: |
          cd src/services/gateway
          npm ci || npm install

      - name: Lint Gateway (ESLint)
        run: |
          cd src/services/gateway
          npm run lint || echo "::warning::ESLint found issues in gateway"

      - name: Format check Gateway (Prettier)
        run: |
          cd src/services/gateway
          npm run format:check || echo "::warning::Prettier found formatting issues in gateway"

      # Processor (Python) - Ruff & Black
      - name: Install Python linters
        run: pip install ruff black

      - name: Lint Processor (Ruff) - new code only
        run: |
          cd src/services/processor
          ruff check . --diff || echo "::warning::Ruff found issues in processor"

      - name: Format check Processor (Black)
        run: |
          cd src/services/processor
          black --check . || echo "::warning::Black found formatting issues in processor"

      # Go services - golangci-lint (new code only)
      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: v1.55
          args: --new-from-rev=origin/main
          working-directory: src/services/metrics-engine
        continue-on-error: true

      - name: Lint read-model (golangci-lint)
        uses: golangci/golangci-lint-action@v4
        with:
          version: v1.55
          args: --new-from-rev=origin/main
          working-directory: src/services/read-model
        continue-on-error: true

      # Rust TUI - Clippy & rustfmt
      - name: Lint TUI (Clippy)
        run: |
          cd src/interfaces/tui
          cargo clippy -- -D warnings 2>&1 || echo "::warning::Clippy found issues in TUI"

      - name: Format check TUI (rustfmt)
        run: |
          cd src/interfaces/tui
          cargo fmt --check || echo "::warning::rustfmt found formatting issues in TUI"

      # Commitlint - verify last commit
      - name: Install root dependencies
        run: npm ci || npm install

      - name: Lint commit message
        run: npm run lint:commits || echo "::warning::Commit message does not follow Conventional Commits"

  # ============================================================
  # Release (Future extensibility)
  # ============================================================
  # release:
  #   name: Create Release
  #   runs-on: ubuntu-latest
  #   needs: [bazel, docker]
  #   if: startsWith(github.ref, 'refs/tags/v')
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Create GitHub Release
  #       uses: softprops/action-gh-release@v1
