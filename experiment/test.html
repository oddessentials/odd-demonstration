<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Mermaid Task Flow — Fancy Animated</title>

    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>

    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 24px;
        background: #0b0f14;
        color: #e7eef7;
      }

      .mermaid {
        background: #0f1621;
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        overflow: auto;
      }

      @keyframes flow {
        from { stroke-dashoffset: 0; }
        to   { stroke-dashoffset: -36; }
      }

      @keyframes glow {
        0%   { filter: drop-shadow(0 0 2px rgba(46, 139, 87, 0.35)); }
        50%  { filter: drop-shadow(0 0 8px rgba(46, 139, 87, 0.65)); }
        100% { filter: drop-shadow(0 0 2px rgba(46, 139, 87, 0.35)); }
      }
    </style>
  </head>

  <body>
    <!-- prettier-ignore -->
    <div class="mermaid" id="diagram">
flowchart LR
    %% NOTE:
    %% linkStyle indices are order-dependent.
    %% If you add/remove edges above, update the linkStyle ranges below.

    subgraph Interfaces
        Browser["Browser (xterm.js)"]
        WebUI["web-ui-http (nginx)"]
        TUI["odd-dashboard TUI (Rust/ratatui)"]
    end
    subgraph EdgeServices["Edge & Access"]
        WebPTY["web-pty-ws (Rust)"]
        Gateway["Gateway API (Node.js)"]
        ReadModel["Read Model API (Go)"]
    end
    subgraph CoreServices["Core Services"]
        Processor["Processor (Python)"]
        Metrics["Metrics Engine (Go)"]
    end
    subgraph Data["Data & Messaging"]
        RabbitMQ["RabbitMQ (event spine)"]
        Postgres["PostgreSQL (authoritative)"]
        Mongo["MongoDB (event store)"]
        Redis["Redis (cache)"]
    end
    subgraph Observability
        Prometheus["Prometheus"]
        Grafana["Grafana"]
    end
    subgraph Testing["Test Framework"]
        Unit["Unit Tests<br/>(vitest / go test / pytest / cargo)"]
        Contracts["Contract Validator<br/>scripts/validate-contracts.ps1"]
        Smoke["Smoke Test<br/>scripts/smoke-test.ps1"]
        Integration["Integration Gate/Harness<br/>scripts/integration-gate.ps1<br/>scripts/integration-harness.ps1"]
        Visual["Playwright Visual Tests<br/>tests/visual"]
    end

    %% Core runtime connections
    Browser --> WebUI
    WebUI -->|WebSocket| WebPTY
    WebPTY --> TUI
    WebUI -.->|/api| ReadModel
    TUI -.-> ReadModel
    Processor -.-> Postgres
    ReadModel -.-> Postgres
    ReadModel -.-> Mongo
    Metrics -.-> Mongo
    ReadModel -.-> Redis
    Metrics -.-> Redis
    Processor -.-> RabbitMQ
    Metrics -.-> RabbitMQ

    %% Observability (BLUE)
    Prometheus -.-> Metrics
    Grafana -.-> Prometheus

    %% Test framework connections (ORANGE)
    Unit -.-> Gateway
    Unit -.-> Processor
    Unit -.-> Metrics
    Unit -.-> ReadModel
    Unit -.-> WebPTY
    Contracts -.-> Gateway
    Contracts -.-> Processor
    Smoke -.-> Gateway
    Smoke -.-> ReadModel
    Integration -.-> Gateway
    Integration -.-> ReadModel
    Integration -.-> Processor
    Integration -.-> Metrics
    Visual -.-> WebUI

    %% Task creation flow (GREEN, steps 1–6)
    TUI -->|"1. User creates task (e.g., press N in TUI)"| Gateway
    Gateway -->|"2. Publish task event"| RabbitMQ
    RabbitMQ -->|"3. Consume event"| Processor
    Processor -->|"4. Process & write results"| Postgres
    ReadModel -->|"5. Query updated views"| Postgres
    ReadModel -->|"6. Provide status updates"| TUI

    %% Node styling
    classDef flowNode fill:#FFEFD5,stroke:#333,stroke-width:1.5px,color:#000;
    class TUI,Gateway,RabbitMQ,Processor,Postgres,ReadModel flowNode;

    %% Observability edges (blue)
    linkStyle 13 stroke:#1E90FF,stroke-width:3px;
    linkStyle 14 stroke:#1E90FF,stroke-width:3px;

    %% Test framework edges (orange)
    linkStyle 15 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 16 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 17 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 18 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 19 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 20 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 21 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 22 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 23 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 24 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 25 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 26 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 27 stroke:#FF8C00,stroke-width:2.5px;
    linkStyle 28 stroke:#FF8C00,stroke-width:2.5px;

    %% Task flow edges (green)
    linkStyle 29 stroke:#2E8B57,stroke-width:4px;
    linkStyle 30 stroke:#2E8B57,stroke-width:4px;
    linkStyle 31 stroke:#2E8B57,stroke-width:4px;
    linkStyle 32 stroke:#2E8B57,stroke-width:4px;
    linkStyle 33 stroke:#2E8B57,stroke-width:4px;
    linkStyle 34 stroke:#2E8B57,stroke-width:4px;
    </div>

    <script>
      mermaid.initialize({
        startOnLoad: false,
        theme: "dark",
        securityLevel: "loose"
      });

      function animatePath(p, delaySeconds) {
        p.style.strokeDasharray = "10 8";
        p.style.strokeLinecap = "round";
        p.style.strokeLinejoin = "round";
        p.style.animation =
          `flow 1.15s linear ${delaySeconds}s infinite, glow 2.2s ease-in-out ${delaySeconds}s infinite`;
      }

      async function renderAndAnimate() {
        await mermaid.run({ querySelector: "#diagram" });

        const svg = document.querySelector("#diagram svg");
        if (!svg) return;

        // Mermaid v10: edges are typically paths with marker-end. This is robust.
        const edgePaths = Array.from(svg.querySelectorAll("path"))
          .filter(p => p.getAttribute("marker-end"));

        // Animate linkStyle 29..34 by taking edges in order (0-based).
        // If you change edge ordering, these indices must be updated (same as linkStyle).
        const start = 29, end = 34;

        for (let i = start; i <= end; i++) {
          const p = edgePaths[i];
          if (!p) continue;
          animatePath(p, (i - start) * 0.12);
        }
      }

      // Ensure Mermaid has inserted SVG before we style it
      requestAnimationFrame(() => renderAndAnimate());
    </script>
  </body>
</html>
